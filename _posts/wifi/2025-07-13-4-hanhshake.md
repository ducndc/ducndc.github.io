---
layout: post
title: "4 Way Handshake"
date: 2024-04-12 10:00:00 +0700
categories: [WiFi]
---

## Luồng Bản Tin

<div style="text-align: justify; text-indent: 2em;">
Quá trình bắt tay 4 bước là quá trình trao đổi 4 thông điệp giữa điểm truy cập (bộ xác thực) và thiết bị khách (người yêu cầu) để tạo ra một số khóa mã hóa có thể được sử dụng để mã hóa dữ liệu thực tế được gửi qua môi trường không dây [1].
</div>

![H1](/assets/img/wifi/wpa-4-way-handshake-workflow.png)

<div style="text-align: justify; text-indent: 2em;">
Bản tin 1: Điểm truy cập gửi tin nhắn EAPOL kèm theo Anonce (số ngẫu nhiên) đến thiết bị để tạo PTK. Đừng quên rằng thiết bị khách biết địa chỉ MAC của điểm truy cập vì nó được kết nối với điểm truy cập đó. Nó có PMK, Snonce và địa chỉ MAC của chính nó. Khi nhận được Anonce từ điểm truy cập, nó có tất cả các thông tin đầu vào để tạo PTK.
</div>

PTK = PRF (PMK + Anonce + SNonce + Mac (AA)+ Mac (SA))

<div style="text-align: justify; text-indent: 2em;">
Bản tin 2: Sau khi thiết bị tạo PTK, nó sẽ gửi SNonce, thông báo này cần thiết cho điểm truy cập để tạo PTK. Thiết bị gửi EAPOL đến AP thông báo 2 kèm theo MIC (kiểm tra tính toàn vẹn của thông báo) để đảm bảo điểm truy cập có thể xác minh xem thông báo này có bị hỏng hoặc bị sửa đổi hay không. Sau khi AP nhận được SNonce, nó cũng có thể tạo PTK để mã hóa lưu lượng unicast. Đây là thông báo thứ hai được gửi từ thiết bị khách đến AP với SNonce và trường MIC được đặt thành 1.
</div>

<div style="text-align: justify; text-indent: 2em;">
Bản tin 3: Thông báo EAPOL 3 được gửi từ AP đến thiết bị khách chứa GTK. AP tạo GTK mà không cần sự tham gia của thiết bị khách từ GMK.
</div>

<div style="text-align: justify; text-indent: 2em;">
Bản tin 4: Thông báo EPOL thứ tư và cũng là cuối cùng sẽ được gửi từ máy khách đến AP chỉ để xác nhận rằng các Khóa đã được cài đặt.
</div>

## Kết Quả 

<div style="text-align: justify; text-indent: 2em;">
Cổng điều khiển được mở khóa: Sau khi quá trình bắt tay 4 bước hoàn tất thành công, cổng điều khiển ảo chặn toàn bộ lưu lượng truy cập sẽ được mở và lúc này lưu lượng truy cập được mã hóa có thể truyền tải. Lúc này, tất cả lưu lượng truy cập đơn hướng sẽ được mã hóa bằng PTK và tất cả lưu lượng truy cập đa hướng sẽ được mã hóa thông qua GTK được tạo ra trong quá trình bắt tay 4 bước.
</div>

## Deauthentication Reason Code Table

<div style="text-align: justify; text-indent: 2em;">
The following table describes the deauthentication reason codes
</div>

| Code | Meaning |
|------|--------|
| 0    | Reserved. |
| 1    | Unspecified reason. |
| 2    | Previous authentication no longer valid. |
| 3    | STA is leaving or has left IBSS/ESS. |
| 4    | Disassociated due to inactivity. |
| 5    | AP cannot handle all currently associated STAs. |
| 6    | Class 2 frame received from nonauthenticated STA. |
| 7    | Class 3 frame received from nonassociated STA. |
| 8    | STA is leaving or has left BSS. |
| 9    | STA requesting (re)association is not authenticated. |
| 10   | Power Capability element is unacceptable. |
| 11   | Supported Channels element is unacceptable. |
| 12   | Disassociated due to BSS Transition Management. |
| 13   | Invalid element (does not meet Clause 8 specs). |
| 14   | MIC (Message Integrity Code) failure. |
| 15   | 4-Way Handshake timeout. |
| 16   | Group Key Handshake timeout. |
| 17   | Element in 4-Way Handshake inconsistent with other frames. |
| 18   | Invalid group cipher. |
| 19   | Invalid pairwise cipher. |
| 20   | Invalid AKMP. |
| 21   | Unsupported RSNE version. |
| 22   | Invalid RSNE capabilities. |
| 23   | IEEE 802.1X authentication failed. |
| 24   | Cipher suite rejected due to security policy. |


## References

[1] https://www.wifi-professionals.com/2019/01/4-way-handshake

[2] https://www.cisco.com/assets/sol/sb/WAP371_Emulators/WAP371_Emulator_v1-0-1-5/help/Apx_ReasonCodes2.html