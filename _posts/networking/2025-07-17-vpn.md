---
layout: post
title: "Virtual Private Networks (VPN)"
date: 2025-07-17 10:00:00 +0700
categories: [Networking]
---

A **Virtual Private Network (VPN)** creates an encrypted tunnel over a public network, allowing devices and sites to communicate as if they share a private network — regardless of physical location. VPNs are used to connect remote offices, enable secure remote work, and protect traffic from interception on untrusted networks.

---

## Deployment Models

### Site-to-Site VPN

A site-to-site VPN connects two or more fixed locations — offices, data centres, or branch sites — through encrypted tunnels between their respective VPN gateways. Traffic between the sites is encrypted at the gateway, travels over the public internet, and is decrypted at the far end. Users on either side can access shared resources without any VPN client software on their own devices.

![Site-to-site VPN topology](/assets/img/networking/cisco-routers-s2s-ipsec-vpn-1.png)

**Typical use case:** A bank with a head office in Washington and branches in Mumbai and Tokyo. Each branch gateway connects to the head office VPN server. When a user in Mumbai connects, the VPN server assigns them an IP address from the head office's local network range — making them logically local to the head office and able to access internal resources securely over the internet.

![Why VPN diagram](/assets/img/networking/why-vpn.jpg)

### Remote Access VPN

A remote access VPN (also called a mobile VPN) connects individual devices to a central VPN gateway. A user anywhere in the world can connect their laptop or phone to the company VPN gateway and access internal resources — email, file servers, internal applications — as if they were physically on the office network.

![Remote access VPN topology](/assets/img/networking/remote-access-vpn.png)

The two dominant technology frameworks for remote access VPN are **IPsec** and **SSL**, both covered below.

---

## VPN Protocols

| Protocol | Layer | Encryption | Best For |
|----------|-------|------------|----------|
| PPTP | 2 | Weak (outdated) | Legacy Windows only |
| L2TP/IPsec | 2+3 | Strong (via IPsec) | General-purpose tunneling |
| IPsec | 3 | Strong | Site-to-site, enterprise remote access |
| SSL/TLS VPN | 5–7 | Strong | Browser-based or clientless remote access |
| SSTP | 3 | Strong (TLS) | Windows clients through firewalls |
| IKEv2 | 3 | Strong (AES-256) | Mobile devices, fast reconnection |
| OpenVPN | 3 | Strong (OpenSSL) | Cross-platform, open-source deployments |

### PPTP

Point-to-Point Tunneling Protocol was created by Microsoft and is one of the oldest VPN protocols still in use. It uses a TCP control channel and GRE tunneling, relying on PPP for security. PPTP is fast and simple to deploy, but has well-known cryptographic weaknesses. It should be avoided in any security-sensitive context.

### L2TP/IPsec

Layer 2 Tunneling Protocol (L2TP) combines PPTP with Cisco's L2F protocol. L2TP itself provides no encryption — it is almost always paired with IPsec to add confidentiality and integrity. The combination is widely supported but adds overhead from the double encapsulation.

### IPsec

IPsec operates at Layer 3 and can protect any protocol running over IP. It is a flexible framework of protocols and algorithms rather than a single protocol:

- **AH (Authentication Header)** — provides integrity and authentication, but not encryption
- **ESP (Encapsulating Security Payload)** — provides integrity, authentication, and encryption; the overwhelmingly common choice
- **IKE/IKEv2** — handles key exchange and Security Association (SA) negotiation

IPsec works for both site-to-site and remote access scenarios and is the basis of most enterprise VPN deployments. Its main drawback is configuration complexity — both endpoints must be configured consistently.

### SSL VPN

SSL VPNs operate at the application layer and use TLS (the successor to SSL) to secure the tunnel. Because TLS runs over TCP port 443 — the same port as HTTPS — SSL VPNs traverse firewalls and proxies that block other VPN protocols. Many SSL VPNs offer a clientless mode accessible from any browser, making them particularly convenient for remote access users on unmanaged devices.

### SSTP

Secure Socket Tunneling Protocol is Microsoft's VPN protocol, transporting PPP traffic over a TLS channel on TCP port 443. It provides strong encryption, key negotiation, and traffic integrity — and like SSL VPNs, passes through most firewalls. SSTP is well-suited for Windows clients but has limited cross-platform support.

### IKEv2

IKEv2 (Internet Key Exchange version 2) handles SA negotiation and is typically used with IPsec. It supports AES-256 and modern ciphers including Camellia and ChaCha20. IKEv2's main advantage is its **MOBIKE** extension, which allows VPN sessions to survive network changes (e.g., switching from Wi-Fi to cellular) without reconnecting — making it the preferred protocol for mobile devices.

### OpenVPN

OpenVPN is the leading open-source VPN solution. It uses OpenSSL for encryption and TLS for key exchange, and runs over UDP (preferred) or TCP. OpenVPN supports pre-shared certificates, X.509 certificates, and username/password authentication. It is highly configurable, runs on all major platforms, and is widely considered the most trustworthy option for security-sensitive open-source deployments.

---

## Configuring an IPsec Site-to-Site VPN

IPsec VPN setup proceeds in two phases. Phase 1 establishes a secure control channel; Phase 2 sets up the data tunnel. Both peers must be configured consistently — mismatched settings are the most common cause of IPsec tunnel failures.

### Pre-requisites: Authentication

Before starting, decide how the two VPN gateways will authenticate each other:

- **Pre-shared key (PSK)** — simpler to configure; the same key must be entered on both sides
- **Digital certificates** — more scalable and secure for larger deployments; requires a PKI

Both gateways must use the same method.

### Phase 1: IKE SA (Control Channel)

Phase 1 builds an encrypted, authenticated channel that protects the Phase 2 negotiation. It uses **Main mode** or **Aggressive mode**:

| Mode | Identity Protection | Speed | When to Use |
|------|--------------------|----|-------------|
| Main mode | Yes (encrypted) | Slower | Static IP addresses; most site-to-site tunnels |
| Aggressive mode | No (cleartext) | Faster | Dynamic IP addresses; remote access VPNs |

**Phase 1 parameters to configure:**

- **Gateway addresses** — local and remote VPN gateway IPs or hostnames
- **Authentication method** — PSK or certificates
- **Encryption algorithm** — AES-128/192/256 (preferred), 3DES, or DES (avoid)
- **Hashing/integrity algorithm** — SHA-256 or higher (preferred over MD5)
- **Diffie-Hellman group** — Group 14 (2048-bit) or higher; higher = stronger key exchange
- **SA lifetime** — how long before Phase 1 re-authenticates (e.g., 86400 seconds)
- **NAT Traversal** — enable if either gateway is behind a NAT device
- **IKE keepalives** — enable for failover to a backup WAN link when the primary fails

![IKEv2 packet exchange](/assets/img/networking/The-IKEv2-exchanged-packets.png)

### Phase 2: IPsec SA (Data Tunnel)

Phase 2 uses **Quick mode** to establish the IPsec SA that actually carries encrypted traffic. This is where you define what traffic is protected and how.

**Phase 2 parameters to configure:**

- **Traffic selectors** — the source and destination IP ranges that will be sent through the tunnel (your local subnet and the remote subnet)
- **Protocol** — choose **ESP** for encryption + authentication (almost always), or AH for authentication only
- **Encryption algorithm** — AES-256 is the strongest commonly used option; avoid DES
- **Authentication/integrity algorithm** — SHA-256 or higher
- **SA lifetime** — how often the data encryption keys rotate (shorter = more secure, more overhead)
- **Perfect Forward Secrecy (PFS)** — optional but recommended; ensures each session key is independent so a compromised key doesn't expose past traffic. Both peers must support the same DH group for PFS.

> **Tip:** Keep the number of Phase 2 proposals to a minimum and match them exactly to your peer's configuration. Offering many proposals is less secure and harder to troubleshoot.

---

## Protocol Selection Guide

- **New site-to-site enterprise VPN** → IPsec with IKEv2, AES-256, SHA-256, DH Group 14+
- **Mobile / remote access users** → IKEv2/IPsec (for speed and reconnection) or SSL VPN (for firewall traversal)
- **Cross-platform open-source deployment** → OpenVPN
- **Windows-only, through restrictive firewalls** → SSTP
- **Avoid** → PPTP (compromised), L2TP without IPsec (no encryption)

---

## References

1. [SoftEther VPN Features](https://www.softether.org/1-features)
2. [IKEv2 Packet Exchange Diagram — ResearchGate](https://www.researchgate.net/figure/The-IKEv2-exchanged-packets_fig2_323135410)