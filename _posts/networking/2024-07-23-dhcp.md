---
layout: post
title: "Dynamic Host Configuration Protocol (DHCP)"
date: 2025-07-23 10:00:00 +0700
categories: [Networking]
tags: [networking, dhcp, protocol, udp, wireshark, ip-addressing]
excerpt: "A packet-level walkthrough of the DHCP DORA process — Discover, Offer, Request, and Acknowledge — with Wireshark captures and relay agent behavior explained."
---

DHCP automates the assignment of IP addresses and network configuration to devices joining a network. Without it, administrators would need to manually assign an IP address, subnet mask, default gateway, and DNS servers to every device. DHCP handles all of this through a four-step exchange between client and server.

## Lab Setup

The captures in this post come from a wired client obtaining an IP from a Microsoft DHCP server running on a VM. The network includes a switch configured with an SVI (Layer 3 VLAN interface) acting as a DHCP relay, and a Wireless LAN Controller (WLC) with an associated AP.

![Lab topology: Switch, WLC, AP, and DHCP server](/assets/img/networking/dhcp1-00.webp)

A key detail: **the DHCP server lives on a different subnet (VLAN 200) than the client (VLAN 13)**. Since DHCP discovery uses Layer 2 broadcast, it can't cross subnet boundaries on its own — the switch's SVI must relay the packet to the server. This is the DHCP relay agent role.

---

## The DORA Exchange

DHCP uses four messages to assign an address. They are commonly called **DORA**: Discover → Offer → Request → Acknowledge.

![Wireshark capture showing all four DORA packets](/assets/img/networking/dhcp1-03.png)

At the transport layer, DHCP always uses **UDP port 68** (client, `bootpc`) as source and **UDP port 67** (server, `bootps`) as destination — or the reverse when the server replies. DHCP is an extension of the older BOOTP protocol, which is why Wireshark labels the fields as "Bootp."

---

### 1. Discover

The client has no IP address yet, so it broadcasts a **DHCP Discover** message to find any available DHCP servers.

![DHCP Discover packet detail](/assets/img/networking/dhcp1-011.png)

| Layer | Source | Destination |
|-------|--------|-------------|
| Layer 2 (Ethernet) | Client MAC address | `ff:ff:ff:ff:ff:ff` (broadcast) |
| Layer 3 (IP) | `0.0.0.0` (no IP assigned yet) | `255.255.255.255` (subnet broadcast) |
| Layer 4 (UDP) | Port 68 | Port 67 |

The Discover message includes DHCP options such as option 53 (message type), 61 (client identifier), 12 (hostname), 60 (vendor class), and 55 (parameter request list). Servers can use these fields to identify the client and decide what address to offer.

Because this is a Layer 2 broadcast, it reaches all hosts on the local subnet — including the switch's VLAN 13 SVI. Since the DHCP server is on a different subnet, the switch relay agent forwards the Discover upstream.

---

### 2. Offer

The DHCP server responds with a **DHCP Offer**, proposing an IP address and configuration parameters to the client. The switch relay agent forwards this back to the client subnet.

![DHCP Offer packet detail](/assets/img/networking/dhcp1-021.webp)

| Layer | Source | Destination |
|-------|--------|-------------|
| Layer 2 (Ethernet) | Switch VLAN 13 MAC | `ff:ff:ff:ff:ff:ff` (broadcast) |
| Layer 3 (IP) | Switch VLAN 13 IP | `255.255.255.255` |
| Layer 4 (UDP) | Port 67 | Port 68 |

The Offer packet's BOOTP section contains the proposed IP address (`10.10.13.10` in this example), subnet mask, lease duration, default gateway, domain name, and the DHCP server's IP. The switch's VLAN 13 address appears in the **relay agent IP** field of the BOOTP header, which is how the server knows where to send the reply.

---

### 3. Request

The client selects the offered address and broadcasts a **DHCP Request** to formally claim it. Even though the client received the Offer, it still broadcasts the Request rather than unicasting — this informs all DHCP servers on the network which offer was accepted (in case multiple servers responded).

![DHCP Request packet detail](/assets/img/networking/dhcp1-031.webp)

| Layer | Source | Destination |
|-------|--------|-------------|
| Layer 2 (Ethernet) | Client MAC | `ff:ff:ff:ff:ff:ff` (broadcast) |
| Layer 3 (IP) | `0.0.0.0` | `255.255.255.255` |
| Layer 4 (UDP) | Port 68 | Port 67 |

The Request includes the requested IP address and the IP of the chosen DHCP server, allowing any other servers that sent offers to release the addresses they had tentatively reserved.

---

### 4. Acknowledge

The server confirms the assignment with a **DHCP ACK**, and the client can begin using the address.

![DHCP ACK packet detail](/assets/img/networking/dhcp1-04.webp)

| Layer | Source | Destination |
|-------|--------|-------------|
| Layer 2 (Ethernet) | Switch VLAN 13 MAC | `ff:ff:ff:ff:ff:ff` (broadcast) |
| Layer 3 (IP) | Switch VLAN 13 IP | `255.255.255.255` |
| Layer 4 (UDP) | Port 67 | Port 68 |

The destination is still a broadcast because the client doesn't yet have a confirmed IP from the network's perspective. When the client receives the ACK, it verifies that its MAC address appears in the BOOTP client MAC field, then assigns the IP to the NIC.

The final step — visible in the capture immediately after the ACK — is an **ARP request** for the default gateway (`10.10.13.1`, listed in the BOOTP options). This resolves the gateway's MAC address, completing the information the client needs to communicate beyond its local subnet.

---

## Summary

| Step | Message | Client IP | Destination | Purpose |
|------|---------|-----------|-------------|---------|
| 1 | Discover | `0.0.0.0` | `255.255.255.255` | Locate DHCP servers |
| 2 | Offer | *(none)* | `255.255.255.255` | Server proposes an address |
| 3 | Request | `0.0.0.0` | `255.255.255.255` | Client claims the offered address |
| 4 | ACK | *(confirming)* | `255.255.255.255` | Server confirms the assignment |

---

## References

1. [Understanding DHCP — mrncciew.com](https://mrncciew.com/2012/12/27/understanding-dhcp/)