---
layout: post
title: "Giao thức cấu hình máy chủ động (DHCP)"
date: 2025-07-23 10:00:00 +0700
categories: [Networking]
---

## Tổng quan

<div style="text-align: justify; text-indent: 2em;">
Giao thức cấu hình máy chủ động (DHCP) là giao thức quản lý mạng được sử dụng trên mạng Giao thức Internet (IP) để tự động gán địa chỉ IP và các tham số truyền thông khác cho các thiết bị được kết nối với mạng bằng kiến trúc máy khách-máy chủ.
</div>

## Giao thức

<div style="text-align: justify; text-indent: 2em;">
Hình bên dưới có Switch, WLC, AP & máy chủ DHCP (máy chủ Microsoft DHCP trên VM). Switch đã được cấu hình với giao diện SVI cơ bản có địa chỉ cổng được liệt kê.
</div>

![H1](/assets/img/networking/dhcp1-00.webp)

###  DHCP discovery

<div style="text-align: justify; text-indent: 2em;">
Hình bên dưới minh họa cách DHCP hoạt động trong môi trường có dây bằng cách bắt các gói tin wireshark từ giao diện Ethernet của máy tính có dây trong khi nó đang lấy IP từ máy chủ DHCP. Như bạn có thể thấy, có 4 loại gói tin (Discover, Offer, Request, ACK, tức là DORA) được trao đổi trước khi máy tính nhận được IP.
</div>

![H1](/assets/img/networking/dhcp1-03.png)

<div style="text-align: justify; text-indent: 2em;">
Như bạn có thể thấy ở lớp 4, nó sử dụng giao thức UDP với cổng src 68 và cổng des 67, tương ứng với bootpc (máy khách) và bootps (máy chủ). Thực tế, DHCP là một phần mở rộng của giao thức BootP. Thông báo khám phá này bao gồm một số tùy chọn nhất định (53, 61, 12, 60, 55), đôi khi các trường này được sử dụng để xác định máy khách với máy chủ DHCP. Ở lớp 3, src sẽ là 0.0.0.0 (vì chưa có IP) và dst (255.255.255.255) sẽ là tất cả các subnet broadcast. Ở lớp 2, src MAC sẽ là địa chỉ MAC NIC của PC, trong khi dst MAC sẽ là địa chỉ MAC broadcast.
</div>

![H1](/assets/img/networking/dhcp1-011.png)

<div style="text-align: justify; text-indent: 2em;">
Tin nhắn broadcast lớp 2 này sẽ được gửi đến tất cả các máy chủ trong mạng con đó và sẽ đến được SVI của switch (int vlan 13-GW). Vì máy chủ DHCP nằm trong một mạng con khác (vlan 200), tin nhắn DHCP discover này sẽ không đến được đó (tin nhắn broadcast sẽ chỉ giới hạn trong mạng con cục bộ). Sau đó, máy chủ DHCP sẽ gửi tin nhắn DHCP offer.
</div>

###  DHCP offer 

<div style="text-align: justify; text-indent: 2em;">
Khi switch hoạt động như DHCP-Relay (lưu ý rằng địa chỉ IP vlan 13 của switch được liệt kê là địa chỉ IP relay-agent trong gói tin này), nó sẽ nhận thông báo DHCP offer từ máy chủ DHCP và sau đó gửi đến máy khách. Gói tin này bao gồm các tùy chọn Bootp như địa chỉ IP, mặt nạ mạng con, thời gian thuê, IP máy chủ DHCP, tên miền, cổng mặc định, v.v. Cổng nguồn UDP sẽ là 67 (đến từ máy chủ) và cổng đích sẽ là 68 (đến máy khách). Ở lớp 3, switch sẽ đặt địa chỉ IP vlan 13 của nó làm IP nguồn của gói tin này và IP đích sẽ là broadcast lớp 3 (255.255.255.255). Ở lớp 2, nó sẽ được gửi dưới dạng khung broadcast.
</div>

![H1](/assets/img/networking/dhcp1-021.webp)

### DHCP request 

<div style="text-align: justify; text-indent: 2em;">
Khi máy khách nhận được thông báo ưu đãi này, nó sẽ gửi một thông báo yêu cầu DCHP để yêu cầu IP đó. Lúc này, máy khách biết "IP máy khách được cung cấp" trong thông báo DHCP là gì và do đó "Thông báo yêu cầu" sẽ bao gồm IP đó (trong trường hợp này là 10.10.13.10). Nó cũng liệt kê địa chỉ máy chủ DHCP (theo cách này, ngay cả khi nhiều máy chủ DHCP phản hồi, máy khách vẫn có thể chọn máy chủ DHCP nào để yêu cầu IP). Vì lưu lượng đi từ máy khách, cổng nguồn UDP sẽ là 68 và cổng đích sẽ là 67. Tuy nhiên, cổng nguồn lớp 3 sẽ là 0.0.0.0 và đích là 255.255.255.255. Ở lớp hai, thông báo này sẽ được phát sóng.
</div>

![H1](/assets/img/networking/dhcp1-031.webp)

### DHCP ack

<div style="text-align: justify; text-indent: 2em;">
Cuối cùng, máy khách sẽ nhận được DHCP ACK, xác nhận rằng nó có thể sử dụng IP được yêu cầu này. Tuy nhiên, gói tin IP đích này vẫn là gói tin phát sóng lớp 3 (vì máy khách không có IP) và do đó khung lớp 2 cũng được phát sóng.
</div>

![H1](/assets/img/networking/dhcp1-04.webp)

<div style="text-align: justify; text-indent: 2em;">
Khi máy khách nhận được khung này và xử lý, máy khách có thể xác nhận địa chỉ MAC của mình được liệt kê là MAC của máy khách trong trường bootp. Sau đó, nó sẽ gán IP đã cho cho NIC. Như bạn có thể thấy, việc tiếp theo nó sẽ làm là gửi yêu cầu ARP để tìm địa chỉ MAC của gateway (10.10.13.1 được liệt kê trong tùy chọn bootp). Sau đó, máy khách sẽ biết mọi thứ (lớp 2 và 3) để giao tiếp với phần còn lại của mạng.
</div>

## Tài liệu tham khảo

[1] https://mrncciew.com/2012/12/27/understanding-dhcp/
